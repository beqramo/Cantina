rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated (manager/admin)
    function isAuthenticated() {
      return request.auth != null;
    }

    // Dishes collection
    match /dishes/{dishId} {
      // Anyone can read dishes (public information)
      allow read: if true;

      // Only authenticated managers can create dishes
      allow create: if isAuthenticated() &&
                      request.resource.data.keys().hasAll(['name', 'imageUrl', 'thumbsUp', 'thumbsDown', 'createdAt', 'updatedAt', 'tags']) &&
                      request.resource.data.name is string &&
                      request.resource.data.imageUrl is string &&
                      request.resource.data.thumbsUp is int &&
                      request.resource.data.thumbsDown is int &&
                      request.resource.data.tags is list &&
                      // Allow optional fields
                      (!('category' in request.resource.data) || request.resource.data.category is string || request.resource.data.category == null) &&
                      (!('imageProviderNickname' in request.resource.data) || request.resource.data.imageProviderNickname is string || request.resource.data.imageProviderNickname == null) &&
                      (!('nameTokens' in request.resource.data) || request.resource.data.nameTokens is list);

      // Public visitors can only update votes (thumbsUp/thumbsDown)
      // Managers can update any field
      allow update: if (
                        // Public visitors can only update vote counts
                        (!isAuthenticated() &&
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['thumbsUp', 'thumbsDown']) &&
                         request.resource.data.thumbsUp is int &&
                         request.resource.data.thumbsDown is int &&
                         request.resource.data.thumbsUp >= 0 &&
                         request.resource.data.thumbsDown >= 0) ||
                        // Managers can update any field
                        (isAuthenticated() &&
                         // Ensure nameTokens is a list if present
                         (!('nameTokens' in request.resource.data) || request.resource.data.nameTokens is list))
                      );

      // Only managers can delete dishes
      allow delete: if isAuthenticated();
    }

    // Dish requests collection
    match /dishRequests/{requestId} {
      // Anyone can create a request (public visitors can submit dishes)
      allow create: if request.resource.data.keys().hasAll(['name', 'requestedBy', 'status', 'createdAt', 'tags']) &&
                      request.resource.data.status == 'pending' &&
                      request.resource.data.requestedBy is string &&
                      request.resource.data.name is string &&
                      request.resource.data.tags is list &&
                      // Allow optional fields
                      (!('imageUrl' in request.resource.data) || request.resource.data.imageUrl is string || request.resource.data.imageUrl == null) &&
                      (!('category' in request.resource.data) || request.resource.data.category is string || request.resource.data.category == null) &&
                      (!('nickname' in request.resource.data) || request.resource.data.nickname is string || request.resource.data.nickname == null);

      // Only managers can read requests (public visitors should not see pending/approved/rejected requests)
      allow read: if isAuthenticated();

      // Only managers can update requests (approve/reject)
      allow update: if isAuthenticated() &&
                      (request.resource.data.status == 'approved' ||
                       request.resource.data.status == 'rejected');

      // Only managers can delete requests
      allow delete: if isAuthenticated();
    }

    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
